<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theo D√µi Ti·∫øn ƒê·ªô N√¢ng C·∫•p</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        :root {
            --primary: #4CAF50;
            --bg: #1a1a2e;
            --card-bg: #16213e;
            --text: #eaeaea;
            --border: #0f3460;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            padding-top: 280px; /* S·∫Ω ƒë∆∞·ª£c JS c·∫≠p nh·∫≠t t·ª± ƒë·ªông */
        }
        
        /* Sticky Header for Stats */
        .stats-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #0f3460;
            padding: 15px 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .stats-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 1.1em;
        }

        .progress-container {
            width: 100%;
            background-color: #333;
            border-radius: 10px;
            height: 25px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00d2ff 0%, #3a7bd5 100%);
            width: 0%;
            transition: width 0.3s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            text-shadow: 1px 1px 2px black;
        }

        /* Grid Layout */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Gi·∫£m min-width ƒë·ªÉ v·ª´a ƒët nh·ªè */
            gap: 20px;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .card-header {
            font-size: 1.2em;
            color: #ff9f43;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .level-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #2a2a40;
            align-items: center;
        }

        .level-row:last-child {
            border-bottom: none;
        }

        .level-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .level-cost {
            color: #00d2ff;
            font-family: monospace;
            font-size: 1.1em;
        }

        input[type="checkbox"] {
            transform: scale(1.3);
            cursor: pointer;
            accent-color: var(--primary);
        }

        .summary-text {
            color: #aaa;
            font-size: 0.9em;
        }
        
        /* Style cho c√°c thanh ti·∫øn ƒë·ªô nh·ªè (Level Stats) */
        .level-stat-item {
            flex: 1; 
            min-width: 50px; 
            background: #222; 
            border-radius: 4px; 
            padding: 4px; 
            text-align: center; 
            font-size: 11px;
        }

        /* N√∫t thu g·ªçn header */
        #toggle-header-btn {
            position: absolute;
            bottom: -24px;
            left: 50%;
            transform: translateX(-50%);
            background: #0f3460;
            color: #aaa;
            border: 1px solid #0f3460;
            border-top: none;
            border-radius: 0 0 8px 8px;
            padding: 4px 20px;
            cursor: pointer;
            font-size: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            z-index: 999;
        }
        #toggle-header-btn:hover {
            color: #fff;
            background: #16213e;
        }
        
        /* Tr·∫°ng th√°i thu g·ªçn */
        .stats-bar.collapsed #level-progress-container,
        .stats-bar.collapsed .diagram-btn-container {
            display: none !important;
        }
        .stats-bar.collapsed {
            padding-bottom: 10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                /* Padding top handled by JS */
                padding-left: 10px;
                padding-right: 10px;
            }
            
            .stats-bar {
                padding: 10px;
            }

            .stats-info {
                flex-direction: column;
                align-items: center;
                gap: 5px;
                font-size: 0.95em;
            }
            
            /* Chuy·ªÉn 6 thanh ti·∫øn ƒë·ªô th√†nh l∆∞·ªõi 3 c·ªôt x 2 h√†ng cho g·ªçn */
            #level-progress-container {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr);
                gap: 5px;
            }
            
            .grid-container {
                grid-template-columns: 1fr; /* 1 c·ªôt duy nh·∫•t tr√™n mobile */
                gap: 15px;
            }
            
            /* N√∫t s∆° ƒë·ªì full width */
            .stats-bar button {
                width: 100%;
                padding: 10px 0;
            }
            
            .view-switcher {
                width: 100%;
                justify-content: center;
            }
        }

        .view-switcher {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }
        .view-btn {
            background: #16213e; border: 1px solid #ff9f43; color: #aaa; padding: 8px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;
        }
        .view-btn.active {
            background: #ff9f43; color: #1a1a2e;
        }
    </style>
</head>
<body>

    <div class="stats-bar">
        <div class="stats-info">
            <span>üèõÔ∏è T·ªïng c√¥ng tr√¨nh: <span id="building-count" style="color: #ff9f43;">0</span></span>
            <span>‚ö° ƒê√£ n·∫°p: <span id="current-mana">0</span> / <span id="total-mana">0</span> Mana</span>
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar">0%</div>
        </div>
        <!-- Container cho 6 thanh ti·∫øn ƒë·ªô nh·ªè -->
        <div id="level-progress-container" style="display: flex; gap: 5px; margin-top: 10px; justify-content: space-between; flex-wrap: wrap;">
            <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c t·∫°o b·ªüi JS -->
        </div>
        
        <!-- B·ªô chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô xem -->
        <div class="view-switcher diagram-btn-container">
            <button id="btn-grid" class="view-btn active" onclick="switchView('grid')">üìã Danh S√°ch</button>
            <button id="btn-diagram" class="view-btn" onclick="switchView('diagram')">üó∫Ô∏è S∆° ƒê·ªì Li√™n K·∫øt</button>
        </div>
        <div id="toggle-header-btn" onclick="toggleHeader()">üîº Thu g·ªçn</div>
    </div>

    <!-- Container S∆° ƒë·ªì (·∫®n m·∫∑c ƒë·ªãnh) -->
    <div id="diagram-view" style="display: none; margin-top: 20px;">
        <div style="background: #16213e; padding: 20px; border-radius: 8px; border: 1px solid #ff9f43;">
            <h2 style="text-align: center; color: #ff9f43; margin-top: 0;">S∆° ƒê·ªì Ph·ª• Thu·ªôc</h2>
            
            <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 10px;">
                <button onclick="zoomDiagram(0.2)" style="background: #4CAF50; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer;">‚ûï Ph√≥ng to</button>
                <button onclick="resetZoom()" style="background: #2196F3; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer;">üîÑ M·∫∑c ƒë·ªãnh</button>
                <button onclick="zoomDiagram(-0.2)" style="background: #f44336; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer;">‚ûñ Thu nh·ªè</button>
            </div>
            
            <div id="diagram-scroll-container" style="overflow: hidden; height: 70vh; border: 1px solid #333; background: #1a1a2e; border-radius: 4px; position: relative; cursor: grab; touch-action: none;">
                <div id="diagram-layer" style="transform-origin: 0 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center;">
                    <div class="mermaid" style="text-align: center;">
                %%{init: {'theme': 'dark', 'flowchart': {'curve': 'basis'}}}%%
                flowchart TD
                %% Nodes
                Castle((üè∞ L√¢u ƒë√†i))
                Barracks(‚öîÔ∏è Doanh Tr·∫°i)
                Infirmary(üè• B·ªánh X√°)
                Embassy(üè≥Ô∏è S·ª© Qu√°n)
                Hall(ü§ù H·ªôi Chi·∫øn)
                Monster(üêâ Tr·∫°i Qu√°i V·∫≠t)
                Spire(‚ú® ƒê·ªânh K·ª≥ B√≠)
                Soul(üëª H·ªìn)
                Gym(üèãÔ∏è Ph√≤ng T·∫≠p)
                Academy(üéì H·ªçc Vi·ªán)
                ManaRoom(üîÆ Ph√≤ng Mana)
                Workshop(‚öôÔ∏è X∆∞·ªüng)
                Cav{{üêé K·ªµ binh}}
                Inf{{üõ°Ô∏è B·ªô binh}}
                Range{{üèπ Cung}}
                Moon(üåô X∆∞·ªüng ƒë√° trƒÉng)
                Vault(üí∞ H·∫ßm Ch·ª©a)
                Manor(üè° Trang Vi√™n)
                Wall(üß± T∆∞·ªùng Th√†nh)
                Ore(‚õèÔ∏è Qu·∫∑ng)
                Market(‚öñÔ∏è Th∆∞∆°ng H·ªôi)
                Stone(ü™® ƒê√°)
                Food(üåæ L√∫a)
                Temple(‚õ©Ô∏è ƒê·ªÅn Th·ªù)
                Wood(üå≤ G·ªó)
                Prison(‚õìÔ∏è Nh√† T√π)
                ManaMine(üíé M·ªè mana)

                %% Relationships
                Castle --> Monster
                Castle --> Vault
                Castle --> Ore
                Castle --> Market
                Castle --> Stone
                Castle --> Food
                Castle --> Wood
                Castle --> ManaMine
                Castle --> Moon

                %% Custom Dependencies
                Ore --> Workshop
                Workshop --> Wall
                Prison --> Temple
                Food --> Manor
                Wood --> Manor
                Manor --> Prison
                Stone --> Barracks
                Stone --> Embassy

                Barracks --> Infirmary
                Embassy --> Hall
                Monster --> Spire
                Monster --> Soul
                Monster --> Gym

                %% Academy Requirements
                Infirmary --> Academy
                Hall --> Academy
                Spire --> Academy
                Soul --> Academy
                Gym --> Academy
                Vault --> Academy
                Wall --> Academy
                Market --> Academy
                Temple --> Academy
                ManaMine --> Academy

                %% Mana Room
                Academy --> ManaRoom
                Moon --> ManaRoom

                %% Troops
                ManaRoom --> Cav
                ManaRoom --> Inf
                ManaRoom --> Range
                
                %% Styling
                classDef default fill:#2a2a40,stroke:#555,color:#eee,rx:10,ry:10,stroke-width:2px;
                classDef castle fill:#d32f2f,stroke:#ffcdd2,stroke-width:4px,color:#fff,font-weight:bold,font-size:16px;
                classDef resource fill:#388e3c,stroke:#a5d6a7,color:#fff;
                classDef military fill:#f57c00,stroke:#ffe0b2,color:#fff;
                classDef advanced fill:#7b1fa2,stroke:#e1bee7,color:#fff;
                classDef basic fill:#1976d2,stroke:#bbdefb,color:#fff;
                classDef troop fill:#455a64,stroke:#cfd8dc,color:#fff,stroke-dasharray: 5 5;
                
                class Castle castle;
                class Food,Wood,Stone,Ore,ManaMine,Moon resource;
                class Barracks,Infirmary,Embassy,Hall,Prison,Temple military;
                class Monster,Spire,Soul,Gym,Academy,ManaRoom,Workshop advanced;
                class Vault,Manor,Wall,Market basic;
                class Cav,Inf,Range troop;
                
                linkStyle default stroke:#00d2ff,stroke-width:2px,fill:none;
            </div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid-container" id="app" style="display: grid;">
        </div>

<script>
    mermaid.initialize({ startOnLoad: false, theme: 'dark' });

    // X·ª≠ l√Ω thu g·ªçn/m·ªü r·ªông Header
    function toggleHeader() {
        const header = document.querySelector('.stats-bar');
        const btn = document.getElementById('toggle-header-btn');
        header.classList.toggle('collapsed');
        
        if (header.classList.contains('collapsed')) {
            btn.innerHTML = 'üîΩ M·ªü r·ªông';
        } else {
            btn.innerHTML = 'üîº Thu g·ªçn';
        }
        updateBodyPadding();
    }

    function updateBodyPadding() {
        const header = document.querySelector('.stats-bar');
        // Th√™m 20px kho·∫£ng c√°ch
        document.body.style.paddingTop = (header.offsetHeight + 20) + 'px';
    }

    // X·ª≠ l√Ω Zoom s∆° ƒë·ªì
    let scale = 1;
    let pointX = 0;
    let pointY = 0;
    let isPanning = false;
    let startX = 0;
    let startY = 0;

    const container = document.getElementById('diagram-scroll-container');
    const layer = document.getElementById('diagram-layer');

    function setTransform() {
        layer.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
    }

    window.zoomDiagram = function(delta) {
        const rect = container.getBoundingClientRect();
        const cx = rect.width / 2;
        const cy = rect.height / 2;
        const factor = delta > 0 ? 1.2 : 0.8;
        const newScale = scale * factor;
        
        pointX = cx - (cx - pointX) * (newScale / scale);
        pointY = cy - (cy - pointY) * (newScale / scale);
        scale = newScale;
        setTransform();
    }

    window.resetZoom = function() {
        scale = 1;
        pointX = 0;
        pointY = 0;
        setTransform();
    }

    // Mouse Wheel Zoom (Google Maps style)
    container.addEventListener('wheel', (e) => {
        e.preventDefault();
        const rect = container.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;
        const delta = -Math.sign(e.deltaY);
        const factor = delta > 0 ? 1.1 : 0.9;
        const newScale = scale * factor;
        
        if (newScale < 0.1 || newScale > 10) return;

        pointX = mx - (mx - pointX) * (newScale / scale);
        pointY = my - (my - pointY) * (newScale / scale);
        scale = newScale;
        setTransform();
    }, { passive: false });

    // Mouse Pan
    container.addEventListener('mousedown', (e) => {
        isPanning = true;
        startX = e.clientX - pointX;
        startY = e.clientY - pointY;
        container.style.cursor = 'grabbing';
    });

    window.addEventListener('mousemove', (e) => {
        if (!isPanning) return;
        e.preventDefault();
        pointX = e.clientX - startX;
        pointY = e.clientY - startY;
        setTransform();
    });

    window.addEventListener('mouseup', () => {
        if (isPanning) {
            isPanning = false;
            container.style.cursor = 'grab';
        }
    });

    // Touch Logic (Pinch + Pan)
    let initialDist = 0;
    let initialScale = 1;

    container.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1) {
            isPanning = true;
            startX = e.touches[0].clientX - pointX;
            startY = e.touches[0].clientY - pointY;
        } else if (e.touches.length === 2) {
            isPanning = false;
            initialDist = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            initialScale = scale;
        }
    }, { passive: false });

    container.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (e.touches.length === 1 && isPanning) {
            pointX = e.touches[0].clientX - startX;
            pointY = e.touches[0].clientY - startY;
            setTransform();
        } else if (e.touches.length === 2 && initialDist > 0) {
            const currentDist = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            const rect = container.getBoundingClientRect();
            const cx = (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left;
            const cy = (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top;
            
            const factor = currentDist / initialDist;
            const newScale = initialScale * factor;
            
            pointX = cx - (cx - pointX) * (newScale / scale);
            pointY = cy - (cy - pointY) * (newScale / scale);
            scale = newScale;
            setTransform();
        }
    }, { passive: false });

    container.addEventListener('touchend', (e) => {
        if (e.touches.length < 2) initialDist = 0;
        if (e.touches.length === 0) isPanning = false;
    });

    let isDiagramRendered = false;
    
    async function switchView(mode) {
        const grid = document.getElementById('app');
        const diagram = document.getElementById('diagram-view');
        const btnGrid = document.getElementById('btn-grid');
        const btnDiagram = document.getElementById('btn-diagram');

        if (mode === 'grid') {
            grid.style.display = 'grid';
            diagram.style.display = 'none';
            btnGrid.classList.add('active');
            btnDiagram.classList.remove('active');
        } else {
            grid.style.display = 'none';
            diagram.style.display = 'block';
            btnGrid.classList.remove('active');
            btnDiagram.classList.add('active');
            
            if (!isDiagramRendered) {
                if (mermaid.run) {
                    await mermaid.run({ nodes: document.querySelectorAll('.mermaid') });
                } else {
                    mermaid.init(undefined, document.querySelectorAll('.mermaid'));
                }
                isDiagramRendered = true;
            }
        }
    }

    // D·ªØ li·ªáu th√¥ t·ª´ CSV c·ªßa b·∫°n (ƒê√£ ƒë∆∞·ª£c x·ª≠ l√Ω th√†nh text ƒë·ªÉ JS parse)
    const rawCsvData = `
l√¢u ƒë√†i,,L√¢u ƒë√†i ,,21955,h·∫ßm ch·ª©a,,H·∫ßm Ch·ª©a,,2855
,True,LV1,242,1210,,True,LV1,31,155
,True,LV2,363,1815,,True,LV2,47,235
,False,LV3,545,2725,,False,LV3,71,355
,False,LV4,818,4090,,False,LV4,106,530
,False,LV5,1227,6135,,False,LV5,160,800
,False,LV6,1196,5980,,False,LV6,156,780
t√≤a h·ªôi chi·∫øn,,H·ªôi Chi·∫øn,,4555,b·ªánh x√°,,B·ªánh X√°,,5075
,True,LV1,50,250,,True,LV1,88,440
,False,LV2,77,385,,True,LV2,115,575
,False,LV3,113,565,,False,LV3,150,750
,False,LV4,169,845,,False,LV4,195,975
,False,LV5,254,1270,,False,LV5,253,1265
,False,LV6,248,1240,,False,LV6,214,1070
Ph√≤ng Mana,,Ph√≤ng Mana,,114810,Doanh Tr·∫°i,,Doanh Tr·∫°i,,7100
,True,LV1,817,4085,,True,LV1,78,390
,False,LV2,1390,6950,,True,LV2,117,585
,False,LV3,2363,11815,,False,LV3,176,880
,False,LV4,4017,20085,,False,LV4,265,1325
,False,LV5,6829,34145,,False,LV5,397,1985
,False,LV6,7546,37730,,False,LV6,387,1935
tr·∫°i qu√°i v·∫≠t,,Tr·∫°i Qu√°i V·∫≠t,,5080,trang vi√™n,,Trang Vi√™n,,4055
,True,LV1,50,250,,True,LV1,44,220
,True,LV2,77,385,,True,LV2,67,335
,False,LV3,120,600,,False,LV3,101,505
,False,LV4,187,935,,False,LV4,151,755
,False,LV5,290,1450,,False,LV5,227,1135
,False,LV6,292,1460,,False,LV6,221,1105
T∆∞·ªùng Th√†nh,,T∆∞·ªùng Th√†nh,,20325,qu·∫∑ng,,Qu·∫∑ng,,725
,True,LV1,224,1120,,True,LV1,6,30
,True,LV2,336,1680,,True,LV2,9,45
,False,LV3,505,2525,,False,LV3,15,75
,False,LV4,757,3785,,False,LV4,23,115
,False,LV5,1136,5680,,False,LV5,36,180
,False,LV6,1107,5535,,False,LV6,56,280
Th∆∞∆°ng H·ªôi,,Th∆∞∆°ng H·ªôi,,8660,ƒë√°,,ƒê√°,,725
,True,LV1,95,475,,True,LV1,6,30
,False,LV2,143,715,,True,LV2,9,45
,False,LV3,215,1075,,False,LV3,15,75
,False,LV4,323,1615,,False,LV4,23,115
,False,LV5,484,2420,,False,LV5,36,180
,False,LV6,472,2360,,False,LV6,56,280
S·ª© Qu√°n,,S·ª© Qu√°n,,12865,l√∫a,,L√∫a,,725
,True,LV1,142,710,,True,LV1,6,30
,False,LV2,213,1065,,True,LV2,9,45
,False,LV3,319,1595,,False,LV3,15,75
,False,LV4,479,2395,,False,LV4,23,115
,False,LV5,719,3595,,False,LV5,36,180
,False,LV6,701,3505,,False,LV6,56,280
ƒê·ªÅn Th·ªù,,ƒê·ªÅn Th·ªù,,15545,g·ªó,,G·ªó,,725
,True,LV1,171,855,,True,LV1,6,30
,True,LV2,257,1285,,True,LV2,9,45
,False,LV3,386,1930,,False,LV3,15,75
,False,LV4,579,2895,,False,LV4,23,115
,False,LV5,869,4345,,False,LV5,36,180
,False,LV6,847,4235,,False,LV6,56,280
X∆∞·ªüng,,X∆∞·ªüng,,11510,ƒê·ªânh K·ª≥ B√≠,,ƒê·ªânh K·ª≥ B√≠,,2280
,True,LV1,127,635,,True,LV1,22,110
,True,LV2,190,950,,True,LV2,35,175
,False,LV3,286,1430,,False,LV3,54,270
,False,LV4,429,2145,,False,LV4,84,420
,False,LV5,643,3215,,False,LV5,130,650
,False,LV6,627,3135,,False,LV6,131,655
Nh√† T√π,,Nh√† T√π,,8125,h·ªìn,,H·ªìn,,1520
,True,LV1,89,445,,True,LV1,15,75
,True,LV2,134,670,,True,LV2,23,115
,False,LV3,202,1010,,False,LV3,36,180
,False,LV4,303,1515,,False,LV4,56,280
,False,LV5,454,2270,,False,LV5,87,435
,False,LV6,443,2215,,False,LV6,87,435
H·ªçc Vi·ªán,,H·ªçc Vi·ªán,,12595,Ph√≤ng T·∫≠p,,Ph√≤ng T·∫≠p,,2430
,True,LV1,139,695,,True,LV1,24,120
,False,LV2,208,1040,,True,LV2,37,185
,False,LV3,313,1565,,False,LV3,57,285
,False,LV4,469,2345,,False,LV4,89,445
,False,LV5,704,3520,,False,LV5,139,695
,False,LV6,686,3430,,False,LV6,140,700
K·ªµ binh,,K·ªµ s·∫°c mana,,30425,B·ªô binh,,B·ªô s·∫°c mana,,30425
,True,LV1,299,1495,,True,LV1,299,1495
,False,LV2,460,2300,,False,LV2,460,2300
,False,LV3,709,3545,,False,LV3,709,3545
,False,LV4,1091,5455,,False,LV4,1091,5455
,False,LV5,1680,8400,,False,LV5,1680,8400
,False,LV6,1846,9230,,False,LV6,1846,9230
x∆∞·ªüng ƒë√° trƒÉng,,x∆∞·ªüng ƒë√° trƒÉng,,35035,Cung,,Cung s·∫°c mana,,30425
,True,LV1,249,1245,,True,LV1,299,1495
,False,LV2,424,2120,,False,LV2,460,2300
,False,LV3,721,3605,,False,LV3,709,3545
,False,LV4,1226,6130,,False,LV4,1091,5455
,False,LV5,2084,10420,,False,LV5,1680,8400
,False,LV6,2303,11515,,False,LV6,1846,9230
m·ªè mana,,m·ªè mana,,4935,,,,,
,True,LV1,29,145,,,,,
,True,LV2,50,250,,,,,
,False,LV3,86,430,,,,,
,False,LV4,147,735,,,,,
,False,LV5,250,1250,,,,,
,False,LV6,425,2125,,,,,
`;

    const buildings = [];

    // H√†m x·ª≠ l√Ω d·ªØ li·ªáu CSV
    function parseData() {
        const lines = rawCsvData.trim().split('\n');
        let currentBuildingLeft = null;
        let currentBuildingRight = null;

        for (let i = 0; i < lines.length; i++) {
            const cols = lines[i].split(',');
            
            // D√≤ng ch·ª©a t√™n (th∆∞·ªùng c√≥ d·ªØ li·ªáu ·ªü c·ªôt 0 ho·∫∑c c·ªôt 5 v√† kh√¥ng ph·∫£i l√† LV)
            if (cols[0] && !cols[0].trim().startsWith(',') && cols[2] && !cols[2].includes('LV')) {
                // Building b√™n tr√°i (C·ªôt 0-4)
                if (cols[0].trim()) {
                    currentBuildingLeft = {
                        name: cols[0].trim().charAt(0).toUpperCase() + cols[0].trim().slice(1), // Vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu
                        levels: []
                    };
                    buildings.push(currentBuildingLeft);
                }
                
                // Building b√™n ph·∫£i (C·ªôt 5-9)
                if (cols[5] && cols[5].trim()) {
                    currentBuildingRight = {
                        name: cols[5].trim().charAt(0).toUpperCase() + cols[5].trim().slice(1),
                        levels: []
                    };
                    buildings.push(currentBuildingRight);
                }
            } 
            // D√≤ng ch·ª©a d·ªØ li·ªáu (LV1-LV6)
            else if (cols[2] && cols[2].includes('LV')) {
                // X·ª≠ l√Ω b√™n tr√°i
                if (currentBuildingLeft) {
                    const isChecked = cols[1].toLowerCase().trim() === 'true';
                    const cost = parseInt(cols[4]) || 0; // L·∫•y c·ªôt T·ªïng
                    currentBuildingLeft.levels.push({ name: cols[2], cost: cost, checked: isChecked });
                }
                // X·ª≠ l√Ω b√™n ph·∫£i
                if (currentBuildingRight && cols[7] && cols[7].includes('LV')) {
                    const isChecked = cols[6].toLowerCase().trim() === 'true';
                    const cost = parseInt(cols[9]) || 0; // L·∫•y c·ªôt T·ªïng
                    currentBuildingRight.levels.push({ name: cols[7], cost: cost, checked: isChecked });
                }
            }
        }
    }

    // H√†m v·∫Ω giao di·ªán
    function renderApp() {
        const app = document.getElementById('app');
        app.innerHTML = ''; // Clear

        buildings.forEach((b, bIndex) => {
            const card = document.createElement('div');
            card.className = 'card';
            
            let html = `<div class="card-header">${b.name}</div>`;
            
            b.levels.forEach((lvl, lIndex) => {
                const baseMana = Math.round(lvl.cost / 5);
                html += `
                <div class="level-row">
                    <label class="level-label" style="flex: 1;">
                        <input type="checkbox" 
                               ${lvl.checked ? 'checked' : ''} 
                               onchange="toggleLevel(${bIndex}, ${lIndex})">
                        ${lvl.name}
                    </label>
                    <span style="flex: 0 0 70px; text-align: center; color: #aaa; font-family: monospace;">${baseMana.toLocaleString()}</span>
                    <span class="level-cost" style="flex: 0 0 85px; text-align: right;">+${lvl.cost.toLocaleString()}</span>
                </div>`;
            });

            card.innerHTML = html;
            app.appendChild(card);
        });

        updateStats();
    }

    // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i khi click checkbox
    window.toggleLevel = function(bIndex, lIndex) {
        buildings[bIndex].levels[lIndex].checked = !buildings[bIndex].levels[lIndex].checked;
        saveData();
        updateStats();
    }

    // H√†m t√≠nh to√°n t·ªïng
    function updateStats() {
        let totalMana = 0;
        let currentMana = 0;
        
        // Kh·ªüi t·∫°o th·ªëng k√™ cho 6 c·∫•p ƒë·ªô
        const levelStats = {};
        for(let i = 1; i <= 6; i++) {
            levelStats[`LV${i}`] = { total: 0, current: 0 };
        }

        buildings.forEach(b => {
            b.levels.forEach(l => {
                totalMana += l.cost;
                if (l.checked) {
                    currentMana += l.cost;
                }
                
                // C·ªông d·ªìn theo c·∫•p ƒë·ªô (LV1, LV2...)
                const lvName = l.name.trim();
                if (levelStats[lvName]) {
                    levelStats[lvName].total += l.cost;
                    if (l.checked) levelStats[lvName].current += l.cost;
                }
            });
        });

        const percent = totalMana === 0 ? 0 : Math.round((currentMana / totalMana) * 100);

        // Update UI Text
        document.getElementById('building-count').innerText = buildings.length;
        document.getElementById('current-mana').innerText = currentMana.toLocaleString();
        document.getElementById('total-mana').innerText = totalMana.toLocaleString();
        
        // Update Progress Bar
        const bar = document.getElementById('progress-bar');
        bar.style.width = percent + '%';
        bar.innerText = percent + '%';
        
        // Update Level Progress Bars (V·∫Ω 6 thanh nh·ªè)
        const lvContainer = document.getElementById('level-progress-container');
        lvContainer.innerHTML = '';
        
        const colors = ['#4CAF50', '#2196F3', '#9C27B0', '#FF9800', '#F44336', '#E91E63'];
        
        for(let i = 1; i <= 6; i++) {
            const key = `LV${i}`;
            const stats = levelStats[key];
            const lvPercent = stats.total === 0 ? 0 : Math.round((stats.current / stats.total) * 100);
            const color = colors[i-1];
            const missing = stats.total - stats.current;
            
            const div = document.createElement('div');
            div.className = 'level-stat-item'; // S·ª≠ d·ª•ng class CSS thay v√¨ inline style
            div.innerHTML = `
                <div style="margin-bottom:2px; color:${color}; font-weight:bold;">${key}</div>
                <div style="font-size: 10px; color: #eee; margin-bottom: 1px;">
                    <span style="color: #4CAF50;" title="ƒê√£ xong">${stats.current.toLocaleString()}</span> / ${stats.total.toLocaleString()}
                </div>
                <div style="font-size: 9px; color: #ff6b6b; margin-bottom: 2px;">
                    Thi·∫øu: ${missing.toLocaleString()}
                </div>
                <div style="background:#444; height:6px; border-radius:3px; overflow:hidden; margin-bottom:2px;">
                    <div style="width:${lvPercent}%; background:${color}; height:100%; transition: width 0.3s;"></div>
                </div>
                <div style="color:#ccc;">${lvPercent}%</div>
            `;
            lvContainer.appendChild(div);
        }
        
        // C·∫≠p nh·∫≠t padding body sau khi render xong (v√¨ chi·ªÅu cao header c√≥ th·ªÉ thay ƒë·ªïi)
        // D√πng setTimeout ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ render
        setTimeout(updateBodyPadding, 100);
    }

    // L∆∞u d·ªØ li·ªáu v√†o LocalStorage
    function saveData() {
        const saveState = {};
        buildings.forEach(b => {
            b.levels.forEach(l => {
                // Key: T√™n nh√† + T√™n c·∫•p (VD: L√¢u ƒë√†i_LV1)
                const key = `${b.name}_${l.name}`;
                saveState[key] = l.checked;
            });
        });
        localStorage.setItem('manaTrackerData', JSON.stringify(saveState));
    }

    // T·∫£i d·ªØ li·ªáu t·ª´ LocalStorage
    function loadData() {
        const saved = localStorage.getItem('manaTrackerData');
        if (!saved) return;
        
        try {
            const saveState = JSON.parse(saved);
            buildings.forEach(b => {
                b.levels.forEach(l => {
                    const key = `${b.name}_${l.name}`;
                    if (saveState.hasOwnProperty(key)) {
                        l.checked = saveState[key];
                    }
                });
            });
        } catch (e) {
            console.error("L·ªói t·∫£i d·ªØ li·ªáu:", e);
        }
    }

    // Kh·ªüi ch·∫°y
    parseData();

    // S·∫Øp x·∫øp l·∫°i th·ª© t·ª± hi·ªÉn th·ªã theo logic s∆° ƒë·ªì li√™n k·∫øt
    const sortOrder = [
        "l√¢u ƒë√†i",
        "qu·∫∑ng", "x∆∞·ªüng", "t∆∞·ªùng th√†nh",
        "ƒë√°", "s·ª© qu√°n", "doanh tr·∫°i", "b·ªánh x√°",
        "g·ªó", "l√∫a", "trang vi√™n", "nh√† t√π", "ƒë·ªÅn th·ªù",
        "h·∫ßm ch·ª©a", "th∆∞∆°ng h·ªôi",
        "t√≤a h·ªôi chi·∫øn",
        "tr·∫°i qu√°i v·∫≠t", "ƒë·ªânh k·ª≥ b√≠", "h·ªìn", "ph√≤ng t·∫≠p",
        "m·ªè mana", "x∆∞·ªüng ƒë√° trƒÉng",
        "h·ªçc vi·ªán",
        "ph√≤ng mana",
        "k·ªµ binh", "b·ªô binh", "cung"
    ];

    buildings.sort((a, b) => {
        const indexA = sortOrder.indexOf(a.name.toLowerCase());
        const indexB = sortOrder.indexOf(b.name.toLowerCase());
        return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
    });

    loadData();
    renderApp();
    
    // L·∫Øng nghe resize ƒë·ªÉ c·∫≠p nh·∫≠t padding
    window.addEventListener('resize', updateBodyPadding);

</script>

</body>
</html>
